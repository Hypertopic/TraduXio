<html>
<head>
  <title>{{work_creator}} : {{work_title}} — TraduXio</title>
  <script src="http://code.jquery.com/jquery-2.0.2.min.js"></script>  
  <script src="shared/traduxio.js"></script>  
  <script type="text/javascript">

  $.fn.toggleName = function(name1, name2) {
    this.text(
      (this.text()==name1)? name2 : name1
    );
  }

  function find(parentType, translationNumber, type) {
    return $("tr").find(parentType + ":nth-child(" + translationNumber + ")")
      .find(type);
  }

  function findUnits(translationNumber) {
    return find("td", translationNumber, ".unit");
  }

  function toggleShow(translationNumber) {
    findUnits(translationNumber).toggle();
    find("th", translationNumber, ".toggle").toggleName("Afficher", "Cacher");
  }

  $.fn.isEdited = function() {
    return this.find("textarea").length>0;
  }

  function htmlToString(unit) {
    return unit.html()
      .replace(/<\/div><div>/g, "\n")
      .replace("<div>", "")
      .replace("</div>", "");
  }

  function stringToHtml(formattedString) {
     return "<div>" 
      + formattedString.replace(/\n/g, "</div><div>")
      + "</div>";
  }

  $.fn.getTranslationNumber = function(ancestor) {
    return this.closest(ancestor).index() + 1;
  }

  $(document).ready(function() {

    $("form").concordancify("{{work_language}}", "");
   
    $(".toggle").on("click", function() {
      toggleShow($(this).getTranslationNumber("th"));
    });

    $(".edit").on("click", function() {
      $(this).toggleName("Lire", "Éditer");
      findUnits($(this).getTranslationNumber("th")).each(function() {
        if ($(this).isEdited()) {
          $(this).html(stringToHtml($(this).find("textarea").val()));
        } else {
          $(this).html("<textarea>" + htmlToString($(this)) + "</textarea>");
        }
      });
    });

    $(".unit").on("focusout", function() {
      $.ajax({
        type: "PUT",
        url: "version/{{id}}?"+ $.param({
          version: $(this).data("version"),
          line: $(this).data("line")
        }),
        contentType: "text/plain",
        data: $(this).find("textarea").val()
      });
    });

    const N = $("th").length;
    for (var i = 3; i<=N; i++) {
      toggleShow(i);
    }

  });

  </script>
</head>
<body>
  <nav>
    <ul>
      <li><a href=".">Œuvres</a></li>
    </ul>
  </nav>
  <form></form>
  <h1>{{work_title}} – {{work_creator}}</h1>
  <table>
    <tr>
      {{#headers}}
        <th>
          {{title}}<br/>
          {{work_creator}}<br/>
          {{language}} — {{creator}} {{date}}<br/>
          {{#creativeCommons}}
            <a href="http://creativecommons.org/licenses/{{creativeCommons}}/3.0/fr">
              <img src="http://i.creativecommons.org/l/{{creativeCommons}}/3.0/88x31.png"/>
            </a>
          {{/creativeCommons}}
          {{^creativeCommons}}
            Tous droits réservés.
          {{/creativeCommons}}
          <br/>
          <button class="toggle">Cacher</button>
          <button class="edit">Éditer</button>
        </th>
      {{/headers}}
    </tr>
    {{#units}}
    <tr>
      {{#versions}}
        <td>{{{.}}}</td>
      {{/versions}}
    </tr>
    {{/units}}
  </table>
</body>
</html>
